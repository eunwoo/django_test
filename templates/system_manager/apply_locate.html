{% extends 'base/head.html' %}
{% block title %}
System Information
{% endblock %}
{% block style %}
<style>
  main {
    width: 70%;
    min-width: 1200px;
    margin: 20px auto;
  }
</style>
{% endblock %}

{% block content %}
{% include 'base/header.html' %}
<main>
  <div class="cont mt-4">
    {% include 'base/navbar_main.html' %}
    <section>
      <div class="container">
        <div class="row ml-0">
          <div class="col">
            <nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
              <ol class="breadcrumb">
                <li class="breadcrumb-item">
                  <a href="{% url 'system_manager:index' %}">기본정보 등록</a>
                </li>
                <li class="breadcrumb-item">설치 위치 등록
                </li>
              </ol>
            </nav>
          </div>
        </div>
      </div>
    </section>
    <div class="container">
      <!--550-->
      <div class="row mt-2">
        <div class="col m-1 p-2 border border-primary border-2 rounded">
          <div class="input-group mb-1">
            <span class="input-group-text" id="basic-addon1">Level1</span>
            <input type="text" class="form-control" placeholder="내용을 입력해주세요." aria-describedby="basic-addon1"
              id="class1_input">
            <button type="button" class="btn btn-primary" onclick="add_locate(1, this)">추가</button>
          </div>

          <div class="form-check" id="class1-list">
            {% for class_item in class1 %}
            <div class="row">
              <div class="col-10">
                <input class="form-check-input" type="radio" name="class1" id="class1_{{class_item.pk}}"
                  value="{{class_item.pk}}">
                <label class="form-check-label" for="class1_{{class_item.pk}}">
                  {{class_item.class1}}
                </label>
              </div>
              <div class="col-2">
                <button type="button" class="btn-close" aria-label="Close" onclick="delete_locate(1, this)"
                  id="class1btn_{{class_item.pk}}"></button>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>

        <div class="col m-1 p-2 border border-primary border-2 rounded">
          <div class="input-group mb-1">
            <span class="input-group-text" id="basic-addon1">Level2</span>
            <input type="text" class="form-control" placeholder="내용을 입력해주세요." aria-describedby="basic-addon1"
              id="class2_input">
            <button type="button" class="btn btn-primary" onclick="add_locate(2, this)">추가</button>
          </div>
          <div class="form-check" id="class2-list">

          </div>
        </div>

        <div class="col m-1 p-2 border border-primary border-2 rounded">
          <div class="input-group mb-1">
            <span class="input-group-text" id="basic-addon1">Level3</span>
            <input type="text" class="form-control" placeholder="내용을 입력해주세요." aria-describedby="basic-addon1"
              id="class3_input">
            <button type="button" class="btn btn-primary" onclick="add_locate(3, this)">추가</button>
          </div>

          <div class="form-check" id="class3-list">
          </div>

        </div>
      </div>

      <div class="container">
        <div class="row justify-content-end">
          <div class="col-1">
            <button type="button" class="btn btn-primary" onclick="apply_locate()">등록</button>
          </div>
        </div>

        <div class="row mt-2">
          <div class="col-12">
            <table style="border-collapse: collapse;" class="col-12" border="1" id="table">
              <tr>
                <th style="width: 5%;">
                  No
                </th>
                <th style="width: 20%;">
                  Level1
                </th>
                <th style="width: 30%;">
                  Level2
                </th>
                <th style="width: 35%;">
                  Level3
                </th>
                <th style="width: 10%;">
                  삭제
                </th>
              </tr>
              {% for locate in install_locate %}
              <tr>
                <td>
                  {{ forloop.counter }}
                </td>
                <td>
                  {{ locate.class2.class1.class1 }}
                </td>
                <td>
                  {{ locate.class2.class2 }}
                </td>
                <td>
                  {{ locate.class3 }}
                </td>
                <td>
                  <button type="button" class="btn btn-danger"
                    onclick="deregistration({{locate.pk}}, '{{locate.class3}}')">삭제</button>
                </td>
              </tr>
              {% endfor %}
            </table>
          </div>
        </div>
      </div>
      <br><br><br>
    </div>
  </div>
  <br><br><br><br><br>

</main>
{% endblock %}

{% block javascript %}
<script type="text/javascript">
  const clear2 = () => {
    document.getElementById("class2-list").innerHTML = "";
  }

  const clear3 = () => {
    document.getElementById("class3-list").innerHTML = "";
  }



  function Class2ChangeEvent() {
    const class2_id = $(this).val();
    $.ajax({
      url: "{% url 'system_manager:get_locate' class_type=0 %}".replace('0', 3),
      type: "GET",
      headers: {
        'X-CSRFToken': '{{ csrf_token }}'
      },
      data: {
        class_id: class2_id,
        class_accept: 0
      },
      success: function (data) {
        const class3_list = document.getElementById("class3-list");
        class3_list.innerHTML = ""
        for (let item of data.install_locate) {
          const class3_list_div = document.createElement("div");
          class3_list_div.className = "row";
          class3_list_div.innerHTML = `
            <div class="col-10">
              <input class="form-check-input" type="checkbox" name="class3" id="class3_${item.id}"
                value="${item.id}">
              <label class="form-check-label" for="class3_${item.id}">
                ${item.class3}
              </label>
            </div>
            <div class="col-2">
              <button type="button" class="btn-close" aria-label="Close" onclick="delete_locate(3, this)"
                id="class3btn_${item.id}"></button>
            </div>`;
          class3_list.appendChild(class3_list_div);
        }
      }
    })
  }

  function Class1ChangeEvent() {
    const class1_id = $(this).val();
    clear2();
    clear3();
    $.ajax({
      url: "{% url 'system_manager:get_locate' class_type=0 %}".replace('0', 2),
      type: "GET",
      headers: {
        'X-CSRFToken': '{{ csrf_token }}'
      },
      data: {
        class_id: class1_id
      },
      success: function (data) {
        const class2_list = document.getElementById("class2-list");
        for (let item of data.install_locate) {
          const class2_list_div = document.createElement("div");
          class2_list_div.className = "row";
          class2_list_div.innerHTML = `
            <div class="col-10">
              <input class="form-check-input" type="radio" name="class2" id="class2_${item.id}"
                value="${item.id}">
              <label class="form-check-label" for="class2_${item.id}">
                ${item.class2}
              </label>
            </div>
            <div class="col-2">
              <button type="button" class="btn-close" aria-label="Close" onclick="delete_locate(2, this)"
                id="class2btn_${item.id}"></button>
            </div>`;
          class2_list.appendChild(class2_list_div);
        }

        // Level 2 선택시 Level 3 설정
        $("input[name=class2]:radio").change(Class2ChangeEvent)
      }
    })
  }

  // 설치 위치 추가 이벤트
  const add_locate = (class_type, e) => {
    const input_element = document.getElementById(`class${class_type}_input`);
    let parent_class_id = 0;
    if (class_type !== 1) {
      if (document.querySelectorAll(`input[name="class${class_type-1}"]:checked`).length < 1) {
        alert(`Level${class_type-1}을 선택해주세요.`);
        return false;
      }
      parent_class_id = document.querySelector(`input[name="class${class_type-1}"]:checked`).value;
    }
    const input_value = input_element.value;
    if (input_value === "") {
      return false;
    }
    input_element.value = "";
    $.ajax({
      url: "{% url 'system_manager:add_locate' %}",
      type: "POST",
      headers: {
        'X-CSRFToken': '{{ csrf_token }}'
      },
      data: {
        class_type: class_type,
        name: input_value,
        class_id: parent_class_id
      },
      success: function (data) {
        if (data.result === "success") {
          const model = JSON.parse(data.data)[0];
          const class_list = document.getElementById(`class${class_type}-list`);
          const class_list_div = document.createElement("div");
          let title, type;
          if (class_type === 1) {
            title = model.fields.class1;
            changeEvent = "Class1ChangeEvent.call(this)";
            type = 'radio';
          } else if (class_type === 2) {
            title = model.fields.class2;
            changeEvent = "Class2ChangeEvent.call(this)";
            type = 'radio'
          } else if (class_type === 3) {
            title = model.fields.class3;
            changeEvent = "";
            type = 'checkbox'
          }
          class_list_div.className = "row";
          class_list_div.innerHTML = `
            <div class="col-10">
              <input class="form-check-input" type="${type}" name="class${class_type}" id="class${class_type}_${model.pk}"
                value="${model.pk}" onchange="${changeEvent}">
              <label class="form-check-label" for="class${class_type}_${model.pk}">
                ${title}
              </label>
            </div>
            <div class="col-2">
              <button type="button" class="btn-close" aria-label="Close" onclick="delete_locate(${class_type}, this)"
                id="class${class_type}btn_${model.pk}"></button>
            </div>`;
          class_list.appendChild(class_list_div);
        }
      }
    })
  }

  const delete_locate = (class_type, e) => {
    $.ajax({
      url: "{% url 'system_manager:delete_locate' %}",
      type: "POST",
      headers: {
        'X-CSRFToken': '{{ csrf_token }}'
      },
      data: {
        class_type: class_type,
        class_id: e.id.split("_")[1]
      },
      success: function (data) {
        e.parentNode.parentNode.remove();
      }
    })
  }


  // Level 1 선택시 Level 2 설정
  $("input[name=class1]:radio").change(Class1ChangeEvent)

  // Level3 선택된 값 모두 불러오기
  const apply_locate = () => {
    const class3_ids = Array.from(document.querySelectorAll("input[name=class3]:checked")).map(item => item
      .value);
    console.log(class3_ids)
    $.ajax({
      url: "{% url 'system_manager:accept_locate' %}",
      type: "POST",
      headers: {
        'X-CSRFToken': '{{ csrf_token }}'
      },
      data: {
        'class_list[]': class3_ids,
      },
      success: function (data) {
        Swal.fire({
          title: '설치위치 설정 완료',
          text: '설치위치 설정이 완료되었습니다.',
          icon: 'success',
          confirmButtonText: '확인'
        }).then(() => {
          location.reload();
        })
      }
    })
  }

  // 설치위치 등록 해제
  const deregistration = (class_id, target) => {
    Swal.fire({
      title: '설치위치 등록 해제',
      text: `[${target}]\n설치위치 등록 해제를 하시겠습니까?`,
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#3085d6',
      cancelButtonColor: '#d33',
      confirmButtonText: '확인',
      cancelButtonText: '취소'
    }).then((result) => {
      if (result.value) {
        $.ajax({
          url: "{% url 'system_manager:deregistration_locate' %}",
          type: "POST",
          headers: {
            'X-CSRFToken': '{{ csrf_token }}'
          },
          data: {
            class_id: class_id
          },
          success: function (data) {
            Swal.fire({
              title: '설치위치 등록 해제 완료',
              text: '설치위치 등록 해제가 완료되었습니다.',
              icon: 'success',
              confirmButtonText: '확인'
            }).then(() => {
              location.reload();
            })
          }
        })
      }
    })
  }
</script>
{% endblock %}